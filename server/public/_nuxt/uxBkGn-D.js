import{_ as st}from"./BzAs22Q4.js";import{c as nt,_ as it,a as rt,b as lt}from"./DJpabBry.js";import{_ as ct}from"./CyY3lptK.js";import{b as ut,a as dt,j as pt,cF as $e,bz as ft,bA as vt,u as mt,bD as Y,bG as ue,f as X,E as _t}from"./Cr5Ubhxi.js";import{E as ht,a as yt}from"./Ct9hkhkX.js";import{E as gt}from"./BR11JheG.js";import{_ as xt}from"./Cn0tjOP5.js";import{u as wt}from"./C91Hnkfk.js";import{l as bt,j as I,b as x,ai as kt,r as de,m as je,c as Rt,E as Ct,k as Et,M as c,N as w,O as s,u as e,$ as qe,Z as _,a3 as z,a6 as v,a1 as f,ag as U,a7 as Ve,a8 as Fe,a4 as pe,a0 as b,_ as fe,ao as ve,aq as Tt,n as St}from"./BgewwvAi.js";import{u as Lt}from"./BflNLQ2W.js";import{u as It,a as zt}from"./t3ylZfTe.js";import{u as At}from"./BtWRx-QN.js";import{_ as Pt}from"./CVnXlxyi.js";import{_ as $t}from"./BR4WaAqe.js";import{C as jt,D as qt,b as Vt,r as Ft,c as Ot,a as Dt,v as Bt,d as Ht}from"./CGpS-fzQ.js";import{P as Nt}from"./CSNrKBDo.js";import{u as Mt}from"./BV2rEcZT.js";import{_ as Ut}from"./BB8ZRXXM.js";import{useSessionFiles as Wt}from"./R7BZfMiN.js";import{E as Oe}from"./B-UECF4z.js";import{_ as Jt}from"./DlAUqK2U.js";import"./WwjzPWiF.js";/* empty css        */import"./DLQfD3Uz.js";import"./Ca-AvAta.js";import"./DkD6xkHx.js";import"./BN2uy5AJ.js";import"./CwafHyED.js";/* empty css        */import"./BLukb3GJ.js";import"./CdGbKsdt.js";import"./Cpg3PDWZ.js";import"./Cp1klw-J.js";import"./vqJmiX2Z.js";import"./DCTLXrZ8.js";/* empty css        */import"./Df5BH_cu.js";/* empty css        */import"./DwFObZc_.js";import"./DQUFgXGm.js";import"./Cljthsfj.js";import"./BK9TZFpY.js";import"./DjUho_vG.js";import"./BtaPwG8Q.js";import"./DJju3RTy.js";import"./BWU-kwnx.js";import"./liHltn2h.js";import"./lURfvm38.js";import"./CvX1p1Zl.js";import"./HhgPgBuu.js";import"./BqfsOZFw.js";import"./DSuzuHr1.js";import"./DP2rzg_V.js";/* empty css        */import"./Dl-E1xuV.js";const De=""+new URL("user_avatar.B42E77Pp.png",import.meta.url).href,Gt={class:"h-full flex flex-col max-w-[720px] mx-auto bg-page rounded-[10px] overflow-hidden",style:{"box-shadow":"0px 5px 40px 0px rgba(0, 0, 0, 0.05)"}},Zt={class:"flex p-main items-center bg-body"},Kt=["src"],Qt={class:"text-2xl line-clamp-1"},Yt={class:"text-tx-secondary line-clamp-1"},Xt={class:"flex-1 min-h-0"},eo={ref:"containerRef",class:"h-full flex flex-col rounded relative"},to={class:"absolute top-0 left-0 w-full h-full flex flex-col z-10"},oo={class:"flex-1 min-h-0"},ao={class:"p-main"},so={class:"my-[5px]"},no={class:"bg-body"},io={class:"flex items-center h-12 px-3 bg-page rounded-lg max-w-xs line-clamp-1 overflow-hidden"},ro={key:0,class:"pb-[10px] text-center text-tx-regular"},lo={key:1,class:"h-full relative"},co=["width","height"],uo={class:"h-full flex justify-center items-center"},po={class:"p-[20px] h-full flex relative z-10"},fo={class:"flex-1 h-full flex flex-col"},vo={class:"flex-1 min-h-0"},mo={class:"flex items-center cursor-pointer"},_o={class:"text-xl flex-1 min-w-0 text-white"},ho={class:"h-full flex"},yo={class:"h-full flex flex-col items-center w-[160px] justify-end"},go=["width","height","id"],xo={class:"text-xs text-white bg-[rgba(51,51,51,0.3)] py-[5px] px-[10px] rounded my-[10px]"},wo={class:"w-[400px] h-full flex flex-col mr-[20px] pt-[100px]"},bo={class:"flex-1 min-h-0 bg-[rgba(0,0,0,0.5)] rounded-[20px] overflow-hidden flex flex-col"},ko={class:"flex-1 min-h-0"},Ro={class:"py-4 px-[20px]"},Co={key:1,class:"h-full flex justify-center text-tx-secondary items-center"},Eo={key:0,class:"flex justify-center items-center py-[10px]"},To={class:"flex flex-col justify-center items-center"},So={class:"flex justify-center mt-4"},Lo=bt({__name:"[key]",async setup(Io){let W,me;const J=ut();Mt();const F=Wt(),Be=dt(),E=pt(),{copy:He}=wt(),ee=I(),{key:k=""}=Be.params,T=x(""),{height:_e,width:zo}=$e(),{data:a}=([W,me]=kt(async()=>Lt(async()=>{const o=await jt({apikey:k}),t=Y("SHARE_CHAT_UNIQUE_ID","");if(!t.value){const[d]=await qt({robot_id:o.robot.id},{authorization:k,password:T.value,identity:E.visitorId});t.value=d}return{...o,uniqueId:t.value}},{default(){return{robot:{}}}},"$89nQiJhyNZ")),W=await W,me(),W),te=I(),A=de({_index:-1,robot_id:a.value.robot.id,record_id:-1,content:""}),Ne=(o,t)=>{var d;A.record_id=o.id,A._index=t,(d=te.value)==null||d.open()},Me=async()=>{var o;try{await Ot(A),(o=te.value)==null||o.close(),A.content="",h.value[A._index].is_feedback=1}catch(t){console.log("反馈提交失败-->",t)}},O=je(()=>a.value.chat_type===2&&a.value.robot.is_digital&&a.value.digital.id&&!a.value.digital.is_disable?2:1);J.isMobile&&O.value===2&&window.location.replace(`/mobile/packages/pages/digital_chat/share_chat?key=${k}`);const he=je(()=>{var o;return((o=a.value.menus)==null?void 0:o.map(t=>({keyword:t})))||[]}),H=async()=>{var t;const o=Y(ue,{});if(T.value=o.value[k]||"",a.value.pwd&&!T.value)return(t=ee.value)==null||t.open(),Promise.reject()},Ue=async o=>{var d;const t=Y(ue,{});T.value=o.password,t.value=Object.assign(t.value,{[k]:o.password}),(d=ee.value)==null||d.close(),Pe()},ye=()=>{const o=Y(ue,{});o.value=Object.assign(o.value,{[k]:""})},h=x([]);let oe=0;const ae=async()=>{try{const o=await Dt({share_apikey:k,identity:E.visitorId,page_size:25e3},{password:T.value,authorization:k,identity:E.visitorId});if(h.value=o.lists||[],setTimeout(()=>{N()}),O.value===2&&y.value==3){const t=h.value[h.value.length-1];t&&t.id!==oe&&(oe=t.id,Qe(oe))}}catch(o){return o=="访问密码错误!"&&(ye(),await H()),Promise.reject()}},ge=async()=>{await H(),await X.confirm("确定清空记录？"),await Vt({},{password:T.value,authorization:k,identity:E.visitorId}),ae()};let u=null;const P=x(!1),G=I(),Z=async(o,t="input")=>{var g;if(await E.getFingerprint(),await H(),!o)return X.msgError("请输入问题");if(P.value)return;P.value=!0,R(3);const d=Date.now(),n=F.files.value.map(i=>({name:i.name,type:"30",url:i.url}));h.value.push({type:1,content:o,files_plugin:n}),h.value.push({type:2,typing:!0,content:"",reasoning:"",key:d}),(g=G.value)==null||g.setInputValue();const l=h.value.find(i=>i.key===d);u=Ft({question:o,unique_id:a.value.uniqueId,stream:!0,files:F.files.value.map(i=>({...i,type:"30"}))},{password:T.value,authorization:k,identity:E.visitorId}),u.addEventListener("reasoning",({data:i})=>{const{data:p,index:C}=i;l.reasoning||(l.reasoning=""),l.reasoning+=p}),u.addEventListener("chat",({data:i})=>{const{data:p,index:C}=i;l.content||(l.content=""),l.content+=p}),u.addEventListener("file",({data:i})=>{try{const p=JSON.parse(i.data);l.files=p}catch(p){console.error(p)}}),u.addEventListener("image",({data:i})=>{try{const p=JSON.parse(i.data);l.images=p}catch(p){console.error(p)}}),u.addEventListener("video",({data:i})=>{try{const p=JSON.parse(i.data);l.videos=p}catch(p){console.error(p)}}),u.addEventListener("close",()=>{l.typing=!1,P.value=!1,setTimeout(async()=>{await ae(),N()},1e3)}),u.addEventListener("error",i=>{var p,C,q;R(1),i.errorType==="connectError"&&X.msgError("请求失败，请重试"),((p=i.data)==null?void 0:p.code)===1200&&(X.msgError((C=i.data)==null?void 0:C.message),ye(),setTimeout(()=>{H()},10)),["connectError","responseError"].includes(i.errorType)&&(h.value.splice(h.value.length-2,2),t==="input"&&((q=G.value)==null||q.setInputValue(o))),l.typing=!1,setTimeout(()=>{P.value=!1},200)})},K=I(),se=x(),N=async()=>{var t,d,n;const o=(d=(t=K.value)==null?void 0:t.wrapRef)==null?void 0:d.scrollHeight;(n=K.value)==null||n.setScrollTop(o)},{height:We}=ft(se);vt(We,()=>{P.value&&N()},{throttle:500,immediate:!0});const y=x(0),Je=de({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中..."}),R=o=>{O.value===2&&(y.value=o)},xe=x(),D=x(!0),ne=x(!1),ie=x(0),$=x(!1),we=x(0),S=de({id:"audio-canvas",width:80,height:40,minHeight:5,scale:2}),{render:Ge,stopRender:Ze,draw:Ao}=It(S),{start:Ke,stop:re,isRecording:M,authorize:be,close:Po,isOpen:$o}=zt({onstart(){R(2),clearTimeout(xe.value),$.value=!1,ie.value=Date.now()},async onstop(o){if(Ze(),$.value=!1,!ne.value){R(1);return}ne.value=!1,R(3);try{const t=await Bt({file:o.blob});if(!t.text){D.value&&j();return}Z(t.text,"voice")}catch{D.value&&j()}},async ondata(o){var d;const t=Date.now();$.value&&Ge(o),o.powerLevel>=10&&(clearTimeout(we.value),y.value=2,$.value=!0,ie.value=t,we.value=setTimeout(()=>{ne.value=!0,clearTimeout(xe.value),Re(),re()},2e3)),t-ie.value>=((d=a.value.digital)==null?void 0:d.idle_time)*1e3&&($.value||(Xe(),re()))}}),{play:ke,pause:Re,audioPlaying:Ce}=At({onstart(){y.value=4,le.value&&(le.value=!1)},onstop(){R(2),D.value?j():R(1)},onerror(){R(1)}}),Qe=async o=>{ke(async()=>await Ee({type:2,record_id:o}),!1)},j=async()=>{M.value||(await be(),Ke())},Ye=async()=>{if(y.value==4){Re(),j();return}y.value!=3&&(M.value?(D.value=!1,re(),R(1)):(D.value=!0,j()))},Ee=async o=>{try{const{url:t}=await Ht(o,{password:T.value,authorization:k,identity:E.visitorId});return t}catch{return R(1),Promise.reject()}},Q=x(""),le=x(!1),Xe=async()=>{if(!a.value.robot.is_digital||!a.value.digital.id||(Q.value||(Q.value=await Ee({type:3,record_id:a.value.robot.id})),!Q.value))return Promise.reject();le.value=!0;const o=Date.now();h.value.push({type:2,typing:!1,content:a.value.digital.idle_reply,key:o}),await St(),N(),ke(Q.value,!1)};Rt(y,o=>{switch(o){case 2:j()}}),I();const ce=I(),{width:Te,height:Se}=$e(),Le=I(),Ie=I(),ze=async o=>new Promise((t,d)=>{const n=document.createElement("video");n.src=o,n.preload="auto",n.loop=!0,n.muted=!0,n.autoplay=!1,n.playsInline=!0,n.play(),n.addEventListener("loadedmetadata",l=>{n.width=n.videoWidth,n.height=n.videoHeight,t(n)}),n.addEventListener("error",l=>{d(l)}),n.addEventListener("play",l=>{Ae()})}),Ae=()=>{if(!ce.value)return;const o=Te.value*2,t=Se.value*2,d=ce.value.getContext("2d");if(!d)return;const n=y.value===4?Ie.value:Le.value;if(!n)return;d.clearRect(0,0,o,t);const{videoHeight:l,videoWidth:g}=n;let i=0,p=0,C=g,q=l;if(g/l>=o/t){const L=o*l/t;i=(g-L)/2,C=L}else{const L=t*g/o;p=(l-L)/2,q=L}d.drawImage(n,i,p,C,q,0,0,o,t),requestAnimationFrame(Ae)},Pe=async()=>{if(await ae(),O.value==2){Le.value=await ze(a.value.digital.wide_stay_video),Ie.value=await ze(a.value.digital.wide_talk_video),D.value=!0;try{await be(),j()}catch{R(1)}setTimeout(()=>{N()},100)}};Ct(async()=>{await E.getFingerprint(),await H(),Pe()});const et=()=>{u==null||u.removeEventListener("reasoning"),u==null||u.removeEventListener("chat"),u==null||u.removeEventListener("close"),u==null||u.removeEventListener("error"),u==null||u.abort()};return Et(()=>{et()}),mt({title:a.value.name}),(o,t)=>{const d=st,n=it,l=rt,g=ct,i=_t,p=ht,C=yt,q=lt,L=nt,tt=gt,ot=xt;return c(),w("div",null,[s("div",{class:"layout-bg",style:pe({height:`${e(_e)=="Infinity"?"100vh":e(_e)+"px"}`})},[e(O)===1?(c(),w("div",{key:0,class:qe(["h-full",{"p-main":!e(J).isMobile}])},[s("div",Gt,[s("div",Zt,[e(a).robot.image?(c(),w("img",{key:0,src:e(a).robot.image,class:"w-[40px] h-[40px] mr-[10px] flex-none rounded-full",alt:""},null,8,Kt)):_("",!0),s("div",null,[s("div",Qt,z(e(a).robot.name),1),s("div",Yt,z(e(a).robot.intro),1)])]),s("div",Xt,[v(tt,{class:"h-full",content:e(J).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}},{default:f(()=>{var m,V;return[s("div",eo,[s("div",to,[s("div",oo,[v(e(Oe),{ref_key:"scrollbarRef",ref:K},{default:f(()=>[s("div",ao,[s("div",{ref_key:"innerRef",ref:se},[e(a).robot.welcome_introducer?(c(),b(n,{key:0,class:"mb-[20px]",type:"left",avatar:`${e(a).robot.icons?e(a).robot.icons:e(a).robot.image}`,bg:"var(--el-bg-color)"},{default:f(()=>[v(d,{content:e(a).robot.welcome_introducer,onClickCustomLink:t[0]||(t[0]=r=>Z(r,"link"))},null,8,["content"])]),_:1},8,["avatar"])):_("",!0),(c(!0),w(fe,null,ve(e(h),(r,B)=>(c(),w("div",{key:r.id+""+B,class:"mt-4"},[r.type==1?(c(),b(n,{key:0,type:"right",bg:"var(--el-color-primary)",color:"white",avatar:e(De)},{actions:f(()=>[s("div",so,[v(i,{link:"",type:"info",onClick:at=>e(He)(r.content)},{icon:f(()=>[v(g,{name:"el-icon-CopyDocument"})]),default:f(()=>[t[4]||(t[4]=U(" 复制 "))]),_:2},1032,["onClick"])])]),default:f(()=>[v(l,{content:r.content,"files-plugin":r.files_plugin},null,8,["content","files-plugin"])]),_:2},1032,["avatar"])):_("",!0),r.type==2?(c(),b(n,{key:1,type:"left",time:r.create_time,avatar:`${e(a).robot.icons?e(a).robot.icons:e(a).robot.image}`,bg:"var(--el-bg-color)"},{outer_actions:f(()=>[r.create_time&&e(a).robot.is_show_feedback?(c(),b(i,{key:0,class:"ml-[52px] mt-2",style:{"--el-button-border-color":"transparent","--el-color-info-light-8":"transparent"},type:r.is_feedback?"info":"primary",plain:!0,bg:"",size:"small",disabled:r.is_feedback,onClick:at=>Ne(r,B)},{default:f(()=>[U(z(r.is_feedback?"已反馈":"反馈"),1)]),_:2},1032,["type","disabled","onClick"])):_("",!0)]),default:f(()=>[r.reasoning?(c(),b(C,{key:0,"model-value":"the-chat-msg-collapse",class:"mb-2 the-chat-msg-collapse"},{default:f(()=>[v(p,{title:"深度思考",name:"the-chat-msg-collapse"},{default:f(()=>[v(l,{content:r.reasoning,class:"text-tx-secondary px-3 border-l-[3px] border-br-light"},null,8,["content"])]),_:2},1024)]),_:2},1024)):_("",!0),v(l,{content:String(r.content),type:"html",typing:r.typing,"show-copy":"","show-context":!!e(a).robot.is_show_context,"show-quote":!!e(a).robot.is_show_quote,"show-voice":e(J).getIsVoiceOpen,context:r.context,quotes:r.quotes,images:r.images,files:r.files,videos:r.videos,"record-id":r.id,"record-type":2,channel:e(k),"user-id":e(E).visitorId},null,8,["content","typing","show-context","show-quote","show-voice","context","quotes","images","files","videos","record-id","channel","user-id"])]),_:2},1032,["time","avatar"])):_("",!0)]))),128))],512)])]),_:1},512)]),s("div",no,[v(L,{ref_key:"chatActionRef",ref:G,loading:e(P),menus:e(he),"btn-color":"#f6f6f6",onEnter:Z,onClear:ge,onPause:t[1]||(t[1]=r=>{var B;return(B=e(u))==null?void 0:B.abort()})},Tt({_:2},[e(a).robot.support_file?{name:"btn",fn:f(()=>[v(Ut,{class:"mr-3",type:"file",multiple:!0,"is-parse-content":!0,"is-only-parse-content":!0,onOnSuccess:e(F).addFile},null,8,["onOnSuccess"])]),key:"0"}:void 0,e(F).files.value.length?{name:"file-list",fn:f(()=>[(c(!0),w(fe,null,ve(e(F).files.value,r=>(c(),b(q,{key:r.id,onClose:B=>e(F).removeFile(r)},{default:f(()=>[s("div",io,z(r.name),1)]),_:2},1032,["onClose"]))),128))]),key:"1"}:void 0]),1032,["loading","menus"]),(m=e(a).robot)!=null&&m.copyright?(c(),w("div",ro,z((V=e(a).robot)==null?void 0:V.copyright),1)):_("",!0)])])],512)]}),_:1},8,["content"])])])],2)):_("",!0),e(O)===2?(c(),w("div",lo,[s("canvas",{ref_key:"canvasRef",ref:ce,id:"digital-canvas",width:e(Te)*2,height:e(Se)*2},null,8,co),U(" "+z(e(y))+" ",1),Ve(s("div",uo,t[5]||(t[5]=[s("img",{class:"w-[400px]",src:Pt,alt:""},null,-1)]),512),[[Fe,e(y)===0]]),Ve(s("div",{class:"h-full",style:pe({background:e(a).robot.digital_bg})},[s("div",po,[s("div",fo,[s("div",vo,[s("div",mo,[s("div",_o,z(e(a).name),1)])]),t[6]||(t[6]=s("div",{class:"flex justify-center"},null,-1))]),s("div",ho,[s("div",yo,[s("div",{class:qe(["recorder gradient-button",{"recorder--stop":!e(M)&&!e(Ce)}]),onClick:Ye},[e($)?(c(),w("canvas",{key:0,style:pe({width:`${e(S).width}px`,height:`${e(S).height}px`}),width:e(S).width*e(S).scale,height:e(S).height*e(S).scale,id:e(S).id},null,12,go)):_("",!0),e(M)&&!e($)?(c(),b(g,{key:1,name:"el-icon-Microphone",size:40})):e(Ce)?(c(),b(g,{key:2,name:"local-icon-pause",size:40})):e(M)?_("",!0):(c(),b(g,{key:3,name:"el-icon-Mute",size:40}))],2),s("div",xo,[s("div",null,z(e(Je)[e(y)]),1)])]),s("div",wo,[s("div",bo,[s("div",ko,[e(h).length?(c(),b(e(Oe),{key:0,ref_key:"scrollbarRef",ref:K},{default:f(()=>[s("div",Ro,[s("div",{ref_key:"innerRef",ref:se},[(c(!0),w(fe,null,ve(e(h),(m,V)=>(c(),w("div",{key:m.id+""+V,class:"mt-4 sm:pb-[20px]"},[m.type==1?(c(),b(n,{key:0,type:"right",avatar:e(De),color:"white"},{default:f(()=>[v(l,{content:String(m.content)},null,8,["content"])]),_:2},1032,["avatar"])):_("",!0),m.type==2?(c(),b(n,{key:1,type:"left",time:m.create_time,avatar:e(a).robot.icons?e(a).robot.icons:e(a).robot.image,bg:"#fff"},{default:f(()=>[m.reasoning?(c(),b(C,{key:0,"model-value":"the-chat-msg-collapse",class:"mb-2 the-chat-msg-collapse"},{default:f(()=>[v(p,{title:"深度思考",name:"the-chat-msg-collapse"},{default:f(()=>[v(l,{content:m.reasoning,class:"text-tx-secondary px-3 border-l-[3px] border-br-light"},null,8,["content"])]),_:2},1024)]),_:2},1024)):_("",!0),v(l,{content:String(m.content),type:"html",typing:m.typing,images:m.images,files:m.files,videos:m.videos,"record-id":m.id,"record-type":2},null,8,["content","typing","images","files","videos","record-id"])]),_:2},1032,["time","avatar"])):_("",!0)]))),128))],512)])]),_:1},512)):(c(),w("div",Co," 暂无聊天记录 "))]),e(P)?(c(),w("div",Eo,[v(i,{color:"#fff",round:"",onClick:t[2]||(t[2]=m=>{var V;return(V=e(u))==null?void 0:V.abort()})},{default:f(()=>t[7]||(t[7]=[U(" 停止 ")])),_:1})])):_("",!0)]),s("div",null,[v(L,{ref_key:"chatActionRef",ref:G,loading:[3,4].includes(e(y)),menus:e(he),"show-pause":!1,"show-clear":!1,onEnter:Z},null,8,["loading","menus"])])]),s("div",To,[s("div",{class:"gradient-button",onClick:ge},[v(g,{name:"local-icon-clear",size:24})])])])])],4),[[Fe,e(y)!==0]])])):_("",!0)],4),v($t,{ref_key:"loginRef",ref:ee,onConfirm:Ue},null,512),v(Nt,{ref_key:"popupRef",ref:te,async:!0,width:"390",title:"问题反馈",appendToBody:!1,class:"feedback-pop"},{footer:f(()=>[s("div",So,[v(i,{type:"primary",onClick:Me},{default:f(()=>t[8]||(t[8]=[U(" 提交反馈 ")])),_:1})])]),default:f(()=>[v(ot,{modelValue:e(A).content,"onUpdate:modelValue":t[3]||(t[3]=m=>e(A).content=m),rows:"8",placeholder:"描述一下你遇到了什么问题"},null,8,["modelValue"])]),_:1},512)])}}}),qa=Jt(Lo,[["__scopeId","data-v-c622168e"]]);export{qa as default};
