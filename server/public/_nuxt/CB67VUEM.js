import{a as ve,_ as ye,c as we}from"./DJpabBry.js";import{_ as be}from"./CyY3lptK.js";import{by as xe,a as ke,l as Ce,b as Ee,j as Le,bz as Re,bA as Se,cH as Te,_ as $e,f as M,E as Ue}from"./Cr5Ubhxi.js";import{E as Ne,a as Me}from"./Ct9hkhkX.js";import{_ as Ae}from"./CGGYEFhd.js";import{E as De}from"./BR11JheG.js";import{u as ze}from"./C91Hnkfk.js";import{l as Be,j as ee,b as k,ai as j,r as Fe,E as Ie,k as Ve,M as u,N as v,a6 as c,a1 as p,O as h,u as e,y as te,Z as E,_ as J,ao as Z,a0 as V,ag as qe,a2 as He,a3 as Oe,$ as Pe,n as oe}from"./BgewwvAi.js";import{u as G}from"./BflNLQ2W.js";import{u as je}from"./CX-Jc4Wd.js";import{b as Je,e as ne,c as Ze}from"./DQUFgXGm.js";import Ge from"./DzCLg3LZ.js";import{E as We}from"./B-UECF4z.js";import{_ as Ye}from"./DlAUqK2U.js";import"./WwjzPWiF.js";/* empty css        */import"./BzAs22Q4.js";import"./DLQfD3Uz.js";import"./Ca-AvAta.js";import"./DkD6xkHx.js";import"./BN2uy5AJ.js";import"./CwafHyED.js";/* empty css        */import"./BLukb3GJ.js";import"./CdGbKsdt.js";import"./Cpg3PDWZ.js";import"./Cp1klw-J.js";import"./vqJmiX2Z.js";import"./DCTLXrZ8.js";/* empty css        */import"./Df5BH_cu.js";import"./BtWRx-QN.js";/* empty css        */import"./DwFObZc_.js";import"./Cljthsfj.js";import"./BK9TZFpY.js";import"./DjUho_vG.js";import"./BtaPwG8Q.js";import"./DJju3RTy.js";import"./BWU-kwnx.js";import"./liHltn2h.js";import"./lURfvm38.js";import"./CvX1p1Zl.js";import"./HhgPgBuu.js";import"./BqfsOZFw.js";import"./Dua6tcUZ.js";import"./lylAQj0-.js";import"./B8eVAIGV.js";import"./BxqZsOx6.js";import"./CthRtmCg.js";/* empty css        *//* empty css        */import"./CSNrKBDo.js";import"./DIG9jm1d.js";import"./BBYJlS94.js";function Ke(A){return $request.get({url:"/chat.skill/lists",params:A})}function Qe(A){return $request.get({url:"/chat.skill/detail",params:A})}const Xe={class:"h-full flex"},et={class:"p-[16px]"},tt={class:"flex-1 min-w-0 pr-4 py-4"},ot={class:"h-full flex flex-col bg-body rounded-[12px]"},nt={class:"flex-1 min-h-0"},at={key:0,class:"px-[40px] pt-[40px]"},rt={class:"my-[5px]"},st={key:0,class:"flex flex-col",style:{"margin-left":"52px"}},lt=["onClick"],it={class:"mr-2 text-tx-primary"},ct={class:"mb-[10px] px-[30px]"},ut={class:"mr-[10px]"},pt=Be({__name:"role",async setup(A){let d,C;const ae=xe(),{copy:re}=ze(),se=ke(),W=Ce(),x=Ee(),y=Le(),D=ee(),q=ee(),Y=k(),z=k(""),L=k(""),w=k(Number(se.query.id)),{data:B,refresh:K}=([d,C]=j(()=>G(()=>Ke({keyword:L.value}),{default(){return[]},lazy:!0,immediate:!1},"$sJo73HUy0r")),d=await d,C(),d),{data:R,refresh:Q}=([d,C]=j(()=>G(()=>Qe({id:w.value}),{lazy:!0,immediate:!1},"$FeZRwM0ASG")),d=await d,C(),d),{data:s,refresh:H}=([d,C]=j(()=>G(()=>Je({type:3,other_id:w.value,page_type:0}),{transform(o){return o.lists||[]},default(){return[]},lazy:!0},"$xhlnmU1xdY")),d=await d,C(),d),_=Fe({show:!1,data:{url:"",name:"",type:"image"}}),le=o=>{_.show=!!o.support_image,_.show||(_.data.url="")},O=({id:o,image:t})=>{W.push({path:"/dialogue/role",query:{id:o}}),w.value=Number(o),oe(async()=>{await H(),R.value={image:t},await Q(),I()})},ie=async()=>{if(!y.isLogin)return y.toggleShowLogin();await M.confirm("确定清空记录？"),await ne({other_id:w.value,type:3}),H()},F=k(-1),{lockFn:ce}=je(async()=>{const o=s.value[s.value.length-1],t=s.value.find(({id:l})=>l===o.id);t&&(F.value=o.id,s.value.splice(s.value.length-2,2),S(t.content))}),ue=()=>{var o;if(!y.isLogin)return(o=D.value)==null||o.blur(),y.toggleShowLogin();I()};let n=null;const b=k(!1),P=k([]),S=async(o,t="input")=>{var T;if(!y.isLogin)return y.toggleShowLogin();if(!o)return M.msgError("请输入问题");if(b.value)return;const l=Date.now();b.value=!0,s.value.push({type:1,content:o,files_plugin:[{..._.data}]}),s.value.push({type:2,typing:!0,content:[""],reasoning:"",key:l}),(T=D.value)==null||T.setInputValue();const a=s.value.find(i=>i.key===l);n=Ze({type:3,other_id:w.value,question:o,model:z.value,file:_.data.url}),n.addEventListener("reasoning",({data:i})=>{const{data:m,index:f}=i;a.reasoning||(a.reasoning=""),a.reasoning+=m}),n.addEventListener("chat",({data:i})=>{const{data:m,index:f}=i;a.content[f]||(a.content[f]=""),a.content[f]+=m}),n.addEventListener("question",({data:i})=>{P.value=JSON.parse(i.data)}),n.addEventListener("finish",({data:i})=>{const{data:m,index:f}=i;m&&(a.content[f]+=m),_.data.url=""}),n.addEventListener("close",async()=>{F.value!==-1&&a.content[0].length&&(await ne({type:1,id:F.value}),F.value=-1),await y.getUser(),b.value=!1,a.typing=!1,setTimeout(async()=>{await H(),await oe(),I()},1e3)}),n.addEventListener("error",async i=>{var m,f;if(t==="input"&&((m=D.value)==null||m.setInputValue(o)),((f=i.data)==null?void 0:f.code)===1100){x.getIsShowRecharge?(await M.confirm(`${x.getTokenUnit}数量已用完，请前往充值`),W.push("/user/recharge")):M.msgError(`${x.getTokenUnit}数量已用完。请联系客服增加`);return}i.errorType==="connectError"&&M.msgError("请求失败，请重试"),["connectError","responseError"].includes(i.errorType)&&s.value.splice(s.value.length-2,2),a.typing=!1,setTimeout(()=>{b.value=!1},200)})},I=async()=>{var t,l,a;const o=(l=(t=q.value)==null?void 0:t.wrapRef)==null?void 0:l.scrollHeight;(a=q.value)==null||a.setScrollTop(o)},{height:pe}=Re(Y);Se(pe,()=>{b.value&&I()},{immediate:!0});const de=()=>{n==null||n.removeEventListener("chat"),n==null||n.removeEventListener("close"),n==null||n.removeEventListener("error"),n==null||n.removeEventListener("finish"),n==null||n.abort(),b.value=!1},me=()=>{if(!w.value)O(B.value[0].skill[0]);else for(let o=0;o<B.value.length;o++){const t=B.value[o];for(let l=0;l<t.skill.length;l++){const a=t.skill[l];if(a.id===w.value){O(a);return}}}};return Te(L,o=>{K()},{debounce:500}),Ie(async()=>{await K(),me(),await Q()}),Ve(()=>{de()}),(o,t)=>{const l=ve,a=ye,T=be,i=Ue,m=Ne,f=Me,fe=Ae,ge=we,he=De,_e=$e;return u(),v("div",null,[c(_e,{name:"default"},{default:p(()=>[h("div",Xe,[h("div",et,[c(Ge,{keyword:e(L),"onUpdate:keyword":t[0]||(t[0]=g=>te(L)?L.value=g:null),sidebarList:e(B),currentId:e(w),onOntoggle:O},null,8,["keyword","sidebarList","currentId"])]),h("div",tt,[c(he,{class:"h-full",content:e(x).getChatConfig.watermark,font:{color:e(ae)?"rgba(256,256,256,0.08)":"rgba(0,0,0,0.06)",fontSize:12}},{default:p(()=>[h("div",ot,[h("div",nt,[c(e(We),{ref_key:"scrollbarRef",ref:q},{default:p(()=>{var g;return[h("div",null,[!e(s).length&&((g=e(R))!=null&&g.tips)?(u(),v("div",at,[c(a,{type:"left",avatar:e(R).image,bg:"var(--el-bg-color-page)"},{default:p(()=>{var r;return[c(l,{content:(r=e(R))==null?void 0:r.tips,type:"html",typing:!1,"line-numbers":!e(x).isMobile,"show-collect-btn":!1,"show-copy-btn":!1,"show-poster":!1,"show-voice":!1,class:"mb-[15px] last-of-type:mb-0",onClickCustomLink:t[1]||(t[1]=$=>S($,"link"))},null,8,["content","line-numbers"])]}),_:1},8,["avatar"])])):E("",!0),e(s).length?(u(),v("div",{key:1,ref_key:"innerRef",ref:Y,class:"px-8"},[(u(!0),v(J,null,Z(e(s),(r,$)=>{var X;return u(),v("div",{key:r.id+""+$,class:"mt-4 sm:pb-[20px]"},[r.type==1?(u(),V(a,{key:0,type:"right",avatar:e(y).userInfo.avatar,color:"white"},{actions:p(()=>[h("div",rt,[c(i,{link:"",type:"info",onClick:U=>e(re)(r.content)},{icon:p(()=>[c(T,{name:"el-icon-CopyDocument"})]),default:p(()=>[t[6]||(t[6]=qe(" 复制 "))]),_:2},1032,["onClick"])])]),default:p(()=>[c(l,{content:r.content,"files-plugin":r.files_plugin},null,8,["content","files-plugin"])]),_:2},1032,["avatar"])):E("",!0),r.type==2?(u(),V(a,{key:1,type:"left",avatar:(X=e(R))==null?void 0:X.image,time:r.create_time,bg:"var(--el-bg-color-page)",modelName:r.model},{outer_actions:p(()=>[$===e(s).length-1&&!e(b)?(u(),v("div",st,[(u(!0),v(J,null,Z(e(P).length?e(P):r.correlation,(U,N)=>(u(),v("div",{key:N,class:"inline-flex items-center rounded-[12px] bg-page cursor-pointer mt-[10px] hover:bg-primary-light-9",style:{padding:"8px 12px",width:"fit-content"},onClick:He(dt=>S(U,"input"),["stop"])},[h("span",it,Oe(U),1),c(T,{name:"el-icon-Right",color:"#999",size:"20"})],8,lt))),128))])):E("",!0)]),default:p(()=>[r.reasoning?(u(),V(f,{key:0,"model-value":"the-chat-msg-collapse",class:"mb-2 the-chat-msg-collapse"},{default:p(()=>[c(m,{title:"深度思考",name:"the-chat-msg-collapse"},{default:p(()=>[c(l,{content:r.reasoning,class:"text-tx-secondary px-3 border-l-[3px] border-br-light"},null,8,["content"])]),_:2},1024)]),_:2},1024)):E("",!0),(u(!0),v(J,null,Z(r.content,(U,N)=>(u(),V(l,{key:N,content:U,type:"html",typing:r.typing,"line-numbers":!e(x).isMobile,"show-rewrite":$===e(s).length-1,"show-copy":"","show-voice":e(x).getIsVoiceOpen,class:Pe(["mb-[15px] last-of-type:mb-0",{"pt-[15px] border-t border-solid border-br-light":N>0}]),index:N,"record-id":r.id,"show-poster":"","record-list":e(s),onRewrite:e(ce)},null,8,["content","typing","line-numbers","show-rewrite","show-voice","class","index","record-id","record-list","onRewrite"]))),128))]),_:2},1032,["avatar","time","modelName"])):E("",!0)])}),128))],512)):E("",!0)])]}),_:1},512)]),h("div",ct,[c(ge,{ref_key:"chatActionRef",ref:D,loading:e(b),"show-continue":e(s).length,"show-file-upload":e(_).show,"file-plugin":e(_).data,"onUpdate:filePlugin":t[3]||(t[3]=g=>e(_).data=g),onEnter:S,onClear:ie,onPause:t[4]||(t[4]=g=>{var r;return(r=e(n))==null?void 0:r.abort()}),onFocus:ue,onContinue:t[5]||(t[5]=g=>S("继续","btn"))},{btn:p(()=>[h("div",ut,[c(fe,{class:"min-w-[280px] select-class",sub_id:e(z),"onUpdate:sub_id":t[2]||(t[2]=g=>te(z)?z.value=g:null),"onUpdate:modelConfig":le},null,8,["sub_id","onUpdate:modelConfig"])])]),_:1},8,["loading","show-continue","show-file-upload","file-plugin"])])])]),_:1},8,["content","font"])])])]),_:1})])}}}),go=Ye(pt,[["__scopeId","data-v-ead26b66"]]);export{go as default};
